---
title: "Spatial Analysis of School Shootings"
author: "J Steven Raquel"
date: "3/10/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(tidyverse)
library(lubridate)
library(sp)
library(spdep)
library(raster)
library(maptools)
library(spatstat)
library(raster)
library(plotrix)
library(ggmap)
library(splancs)
library(tigris)
options(tigris_use_cache = TRUE)
```



```{r reading_data, warnings = F}

# gun control laws 
# violent video game sales
# music


perps <- read_csv("ss_perps.csv", na = c("", "null", "N/A"), 
                  show_col_types = F)
weapons <- read_csv("ss_weapons.csv", na = c("", "null", "N/A"),
                    show_col_types = F)
incidents <- read_csv("ss_incidents.csv", na = c("", "null", "N/A"),
                      show_col_types = F)
# incident dataset filtered
incidents_f <- incidents %>%
  dplyr::select(Incident_ID, Reliability, Date, Quarter, School, 
                City, State, School_Level, Location, Location_Type, 
                During_School, Time_Period, Situation, 
                Bullied, Domestic_Violence, Gang_Related, 
                Preplanned, Shots_Fired) %>%
  mutate(Date = as.Date(Date)) %>%
  filter(!(Situation %in% c("Accidental", "Escalation of Dispute",
                            "Domestic w/ Targeted Victim", "Suicide/Attempted"))
         ) %>%
  filter(Gang_Related == "No") %>%
  filter(Date > "1990-01-01") %>% 
  unite(Full_Location, c(School, City, State), remove = F, sep = " ") %>%
  mutate(Full_Location = as.character(Full_Location))

incidents_f <- incidents_f %>% 
  mutate_at(setdiff(names(incidents_f), c("Incident_ID", "Full_Location", "Date")), 
               .funs = as.factor)

# perpetrator dataset filtered
perps_f <- perps %>% 
  dplyr::select(incidentid, age, gender, race, schoolaffiliation) %>%
  rename(Incident_ID = incidentid, Age = age, Gender = gender, 
         Race = race, School_Affiliation = schoolaffiliation)

# weapon dataset filtered
weapons_f <- weapons %>%
  dplyr::select(incidentid, weapontype) %>%
  rename(Incident_ID = incidentid, Weapon_Type = weapontype)

# Youth Mental Healthcare Rankings
ymhc_2019 <- read_csv("youth_mhc_2019_2.csv", 
                        col_names = T, col_types = "ic") %>%
  rename(Youth_MHC_Rank = Rank, State_Name = State)
ymhc_2019$State <- state.abb[match(ymhc_2019$State_Name, state.name)]

# from tigris
states_shp <- states()
```

```{r get-lat-lon, include = F}
# incidents_f2 <- incidents_f %>% mutate_geocode(Full_Location, output = "latlon")
# write.csv(incidents_f2, "ss_incidents_f2.csv", row.names = F)
incidents_f2 <- read.csv("ss_incidents_f2.csv") %>% 
  dplyr::select(-X) %>%
  filter(!(Situation %in% c("Intentional Property Damage"))) %>%
  filter(!(State %in% c("AK", "HI")))
# adding perpetrator information to the dataset
incidents_f3 <- left_join(incidents_f2, perps_f, by = "Incident_ID")
# adding weapon information to the dataset
incidents_f4 <- left_join(incidents_f3, weapons_f, by = "Incident_ID")
df <- incidents_f4
```

```{r point-plot}
# maps is loaded
states <- map_data("state")

ggplot(data = states, aes(x = long, y = lat, group = group)) + 
  geom_polygon(fill = 'lightgrey', color = 'black') + 
  geom_point(data = df,
             aes(x = lon, y = lat, group = NULL), color = "red", cex = 0.75) +
  ggtitle("School Shootings in US, 1990-Present") +
  theme_minimal()
```




```{r states-ppp}
# sf is loaded
# raster is loaded
# spatstat.geom is loaded
# tigris is loaded
# download US states shapefile
states_shp <- tigris::states()

# parts of the USA to exclude
excludes <- c("Hawaii", "Alaska", "United States Virgin Islands",
              "Commonwealth of the Northern Mariana Islands",
              "Guam", "American Samoa","Puerto Rico")

# subsetting shapefile to only the mainland United States
mainland_shp <- states_shp[!paste(states_shp$NAME) %in% excludes,]
# converting to flat coordinates
# converting to the Albers conical projection
# 5070
mainland_flat <- st_transform(mainland_shp, crs=5070)
# creating a window
mainland_owin <- as.owin(as_Spatial(mainland_flat))

latlon_to_cartesian <- function(lat, lon) {
  
  require(REdaS) # for rad2deg
  
  lat_rad <- deg2rad(lat)
  lon_rad <- deg2rad(lon)
  R <- 6371 # radius of the Earth, in km
  
  x <- R*cos(lat_rad)*cos(lon_rad)
  y <- R*cos(lat_rad)*sin(lon_rad)
  
  coords <- data.frame(x,y)
  
  return(coords)
}

geo_coords <- latlon_to_cartesian(df$lat, df$lon)

# creating ppp object
df_ppp <- ppp(x = geo_coords$x, y = geo_coords$y, 
              window = mainland_owin)
plot(df_ppp, axes = T,main = "Point Process Map, CRS=5070")
```


```{r quadrat.test}
quadrat.test(df_ppp)

# sf object
df_sf <- st_as_sf(df, coords = c("lon", "lat"))
df_sf <- st_set_crs(df_sf, 5070)
```

```{r spdf}
albers <-  CRS("+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 
                                 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs")
df_spdf <- SpatialPointsDataFrame(coords = data.frame(long = df$lon, lat = df$lat),
                                  data = data.frame(Event = rep(1, times = nrow(df))),
                                  proj4string = albers)
events <- df_spdf[df_spdf$Event == 1,]
events_ppp <- as.ppp(X = events)
plot(events_ppp)
```

```{r density}

plot(df_sf, max.plot = 24)
```
